# Setup IDR Docker nodes
# Inspired by https://thisendout.com/2016/09/13/deploying-docker-swarm-with-ansible/
# Host groups must be named $IDR_ENVIRONMENT-a

# TODO: Docker uses an incorrect MTU on OpenStack VMs, and it is not possible
# to easily set it on the swarm ingress network. See this workround:
# https://github.com/docker/docker/issues/24906#issuecomment-235894478
# This must be done before creating the swarm
#     docker network rm docker_gwbridge
#     docker network create --opt com.docker.network.driver.mtu=1400 --subnet 172.18.0.0/16 docker_gwbridge

# TODO: Convert this into one or more roles


- include: idr-kubernetes.yml


- hosts: "{{ idr_environment | default('idr') }}-omeroreadonly-hosts"
  # Empty playbook to force loading of omero-hosts hostvars


- hosts: "{{ idr_environment | default('idr') }}-dockermanager-hosts"

  roles:
  - role: openmicroscopy.versioncontrol-utils
  - role: openmicroscopy.nfs-share
    nfs_shares:
      /data:
      - host: "*"
        options: 'ro'
#  - role: IDR.idr-jupyter

  tasks:

  # Notebooks

  - name: jupyterhub | check if idr-notebooks repo exists
    stat:
      path: "{{ idr_jupyter_notebook_host_volume }}/.git/HEAD"
    register: idr_notebook_st

  # If a repo exists locally don't update it in case there are local changes
  - name: jupyterhub | clone idr-notebooks
    become: yes
    git:
      dest: "{{ idr_jupyter_notebook_host_volume }}/"
      repo: "{{ idr_jupyter_notebook_repo }}"
      force: no
      version: "{{ idr_jupyter_notebook_repo_version | default('HEAD') }}"
    when: not idr_notebook_st.stat.exists

  - name: jupyterhub | create scratch notebooks directory
    become: yes
    file:
      mode: "0755"
      owner: 1000
      path: "{{ idr_jupyter_notebook_host_volume }}/scratch"
      state: directory

  - name: jupyterhub | update jupyter omero connection file
    become: yes
    blockinfile:
      dest: "{{ idr_jupyter_notebook_host_volume }}/library/idr.py"
      state: present
      # This ensures the code will be indented with 4 spaces
      block: |6
                import random
                HOSTNAME = str(random.choice({{ idr_jupyter_omero_host }}))
                USERNAME = "{{ idr_jupyter_omero_user }}"
                PASSWORD = "{{ idr_jupyter_omero_pass | quote }}"

  vars:
  # Mount this volume as /notebooks inside the docker container
  # You must ensure it has the correct permissions for writing
  - idr_jupyter_notebook_host_volume: /data/idr-notebooks
  - idr_jupyter_omero_host: >
      {{
        groups[idr_environment | default('idr') + '-omeroreadonly-hosts'] |
        map('extract', hostvars,
          ['ansible_' + (idr_net_iface | default('eth0')), 'ipv4', 'address']) | list
      }}
  - idr_jupyter_omero_user: public
  - idr_jupyter_omero_pass: public

#  - idr_jupyter_notebook_volumes: >
#      {
#        '{{ idr_jupyter_notebook_host_volume }}': '/notebooks',
#      }

- hosts: "{{ idr_environment | default('idr') }}-dockerworker-hosts"

  tasks:

  - name: jupyterhub | install docker-python
    become: yes
    yum:
      name: docker-python
      state: present

  - name: jupyterhub | pull docker images in advance
    become: yes
    docker_image:
      name: "{{ item }}"
      state: "present"
      force: "{{ idr_docker_pull_latest }}"
    with_items:
    - "{{ idr_jupyter_hub_image }}"
    - "{{ idr_jupyter_notebook_image }}"

  vars:
  - idr_docker_pull_latest: True
