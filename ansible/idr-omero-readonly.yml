# Read-only OMERO
# This must be run after idr-omero.yml since it relies on volumes and
# database setup from a read-write server

# TODO: Consider putting some of this into a role

# OMERO read-write fileserver for OMERO read-only
- hosts: "{{ idr_environment | default('idr') }}-omeroreadwrite-hosts"

  roles:

  - role: openmicroscopy.nfs-share
    nfs_shares:
      /data/OMERO:
      - host: "*"
        options: 'ro'
      /data/OMERO/BioFormatsCache:
      # TODO: Limit which hosts can write to this dir
      - host: "*"
        options: 'rw'

  # Include restart handlers
  - role: openmicroscopy.omero-common

  tasks:
  # Lock down the read-write node in the read-only cluster
  # TODO: This doesn't seem to work, OMERO is still accessible from
  # other servers
  - name: OMERO.server prevent external access
    become: yes
    copy:
      content: |
        config set -- Ice.Default.Host 127.0.0.1
      dest: /opt/omero/server/config/omero-localhostonly-config.omero
      force: yes
    notify:
    - restart omero-server


# Read-only OMERO.server config
- hosts: "{{ idr_environment | default('idr') }}-omeroreadonly-hosts"

  pre_tasks:
  - name: Get fileserver host
    set_fact:
      omero_fileserver_host_ansible: "{{ hostvars[groups[idr_environment | default('idr') + '-omeroreadwrite-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"

  roles:
  - role: openmicroscopy.nfs-mount
    nfs_share_mounts:
    - path: /data/OMERO-readonly
      location: "{{ omero_fileserver_host_ansible }}:/data/OMERO"
      opts: ro
    - path: /data/OMERO/BioFormatsCache
      location: "{{ omero_fileserver_host_ansible }}:/data/OMERO/BioFormatsCache"
      opts: rw,sync

  # Include restart handlers
  - role: openmicroscopy.omero-common

  tasks:

  - name: OMERO.server config directory (pre-install)
    become: yes
    file:
      path: /opt/omero/server/config/
      recurse: yes
      state: directory

  # WARNING: Since this config comes before the omero-server role there is no
  # restart handler
  - name: OMERO.server read-only configuration
    become: yes
    copy:
      content: |
        config set -- omero.data.dir /data/OMERO
        config set -- omero.cluster.read_only true
        config set -- omero.cluster.node_provider ome.security.basic.InMemoryNodeProvider
        config set -- omero.sessions.session_manager ome.services.sessions.InMemorySessionManagerImpl
        config set -- omero.security.event_provider ome.security.basic.InMemoryEventProvider
      dest: /opt/omero/server/config/omero-readonly-config.omero
      force: yes
    notify:
    - restart omero-server

  # There are several bugs- read-only still needs write access to several
  # directories including ManagedRepository/.omero

  - name: OMERO.server read-only data dir
    become: yes
    file:
      path: "{{ item }}"
      owner: "{{ omero_server_system_uid }}"
      state: directory
    with_items:
    - /data/OMERO
    - /data/OMERO/ManagedRepository

  # Note BioFormatsCache is a separate read-write shared cache
  - name: OMERO.server read-only data dir symlinks
    become: yes
    file:
      src: /data/OMERO-readonly/{{ item }}/
      path: /data/OMERO/{{ item }}
      state: link
      force: yes
    with_items:
    - Files
    - FullText
#    - ManagedRepository
    - Pixels
    - Thumbnails
    - .omero

  # And now we need to symlink ManagedRepository/*
  - name: OMERO.server get ManagedRepository dirs
    find:
      file_type: directory
      paths: /data/OMERO-readonly/ManagedRepository/
      recurse: no
    register: omero_ro_managedrepo_dirs

  - name: OMERO.server read-only ManagedRepository symlinks
    become: yes
    file:
      src: "{{ item.path }}"
      path: /data/OMERO/ManagedRepository/{{ item.path | basename }}
      state: link
      force: yes
    with_items: "{{ omero_ro_managedrepo_dirs.files }}"


- hosts: "{{ idr_environment | default('idr') }}-database-hosts"
# Load hostvars


- hosts: "{{ idr_environment | default('idr') }}-omeroreadonly-hosts"
  tasks:
  - name: Get database host
    set_fact:
      omero_db_host_ansible: "{{ hostvars[groups[idr_environment | default('idr') + '-database-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"


- hosts: >
    {{ idr_environment | default('idr') }}-omeroreadonly-hosts

  roles:
  - role: openmicroscopy.omero-server

  environment: "{{ idr_ANSIBLE_ENVIRONMENT_VARIABLES | default({}) }}"
