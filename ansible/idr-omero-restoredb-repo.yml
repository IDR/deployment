---
# restore omero database from compressed dump

- name: omero | prepare files in "{{ omero_datadir }}"
  become: yes
  find:
    path: "{{ omero_datadir }}"
    file_type: file
  register: files

- name: omero | delete content from "{{ omero_datadir }}"
  become: yes
  file:
    state: absent
    path: "{{ item.path }}"
  with_items: 
    - "{{ files.files }}"


- name: omero | prepare directories in "{{ omero_datadir }}"
  become: yes
  find:
    path: "{{ omero_datadir }}"
    file_type: directory
  register: directories

- name: omero | delete content from "{{ omero_datadir }}"
  become: yes
  file:
    state: absent
    path: "{{ item.path }}"
  with_items:
    - "{{ directories.files }}"


- name: omero | restore FullText
  become: yes
  synchronize:
    mode: pull
    compress: no
    src: "{{ rsync_host }}omero/FullText"
    dest: "{{ omero_datadir }}/FullText"
  delegate_to: "{{ hostvars[groups[idr_environment | default('idr') + '-omero-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"

- name: omero | restore Thumbnails
  become: yes
  synchronize:
    mode: pull
    compress: no
    src: "{{ rsync_host }}omero/Thumbnails"
    dest: "{{ omero_datadir }}/Thumbnails"
  delegate_to: "{{ hostvars[groups[idr_environment | default('idr') + '-omero-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"
