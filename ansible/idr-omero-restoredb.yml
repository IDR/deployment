# Example playbook for reseting Database and Data Repository
#
# This is initially aimed at maintenance tasks, e.g. restoring production database


# STOP
- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts

  tasks:
  - name: omero | stop omero server
    become: yes
    systemd:
      name: omero
      state: stopped


# DB MAINTENANCE
- hosts: >
    {{ idr_environment | default('idr') }}-database-hosts

  tasks:
  - name: postgres | rsync and reset db
    become: yes
    include: idr-omero-restoredb-pg.yml
    when: omero_dbreset

  vars:
    rsync_host: "rsync://idr-rsync.openmicroscopy.org/"
    rsync_dest_dbdump: "/tmp/db_dump"
    omero_dbname: idr
    omero_dbreset: False
    omero_dbreset_user_passwords:
      - {'uid': 0, 'password': ""}
      - {'uid': 1, 'password': ""}
      - {'uid': 2, 'password': ""}
      - {'uid': 52, 'password': "{{ omero_web_public_password }}"}


# SERVER MAINTENANCE
- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts

  tasks:
  - name: omero | restore data repository
    become: yes
    include: idr-omero-restoredb-repo.yml
    when: omero_datareporeset

  # Upgrade
  - name: Get database host
    set_fact:
      omero_db_host_ansible: "{{ hostvars[groups[idr_environment | default('idr') + '-database-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"
  - name: omero | set omego db options
    set_fact:
      omero_omego_db_options: >
        --dbhost {{ omero_dbhost | quote }}
        --dbuser {{ omero_dbuser | quote }}
        --dbname {{ omero_dbname | quote }}
        --dbpass {{ omero_dbpassword | quote  }}
  - name: omero | set omego options
    set_fact:
      omero_omego_options: >
        --release {{ omero_release }}
        --sym {{ omero_server_symlink }}
        --prestartfile {{ omero_basedir }}/config/omero-base.config
        --prestartfile {{ omero_basedir }}/config/omero-additional.config
        --ice {{ ice_version }}
        {{ omero_omego_verbosity }}
        {{ omero_omego_additional_args }}
        {{ omero_systemd_setup | ternary('--no-start', '') }}
  # If systemd is enabled don't start anything, leave systemd to handle this
  # later omego will still stop omero and omero-web outside of systemd, so you
  # should ensure the service file contains `Restart=no` (default)
  
  - name: omero | upgrade
    become: yes
    become_user: "{{ omero_system_user }}"
    command: >
      {{ omero_omego_path }}
      upgrade
      {{ omero_omego_options }}
      {{ omero_omego_db_options }}
      --upgradedb
    args:
      chdir: "{{ omero_serverdir }}"
    when: omero_upgrade

  vars:
    rsync_host: "rsync://idr-rsync.openmicroscopy.org/"
    rsync_dest_datadir: "/tmp/data_dir"
    omero_system_user: "omero"
    omero_omego_additional_args: "--downloadurl https://downloads.openmicroscopy.org/idr"
    omero_basedir: /home/omero
    omero_serverdir: "{{ omero_basedir }}"
    omero_server_symlink: OMERO.server
    omero_omego_path: "{{ omero_basedir }}/omego/bin/omego"
    omero_omego_verbosity: "-qq"
    omero_dbhost: "{{ omero_db_host_ansible }}"
    omero_systemd_setup: True
    omero_datareporeset: False
    omero_upgrade: False

# START
- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts

  tasks:
  - name: omero | start omero.server
    become: yes
    systemd:
      name: omero
      state: started

  tasks:
  - name: omero | start omero.web
    become: yes
    systemd:
      name: omero-web
      state: started