# Example playbook for reseting Database and Data Repository
#
# This is initially aimed at maintenance tasks, e.g. restoring production database


# STOP
- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts

  tasks:
  - name: omero | stop omero server
    become: yes
    systemd:
      name: omero
      state: stopped


# DB MAINTENANCE
- hosts: >
    {{ idr_environment | default('idr') }}-database-hosts

  tasks:
  - name: postgres | rsync and reset db
    become: yes
    include: idr-omero-restoredb-pg.yml
    when: omero_dbreset

  vars:
    rsync_host: "rsync://idr-rsync.openmicroscopy.org/"
    rsync_dest_dbdump: "/tmp/db_dump"
    omero_dbname: idr
    omero_dbreset: True
    omero_dbreset_user_passwords:
      - {'uid': 0, 'password': ""}
      - {'uid': 1, 'password': ""}
      - {'uid': 2, 'password': ""}
      - {'uid': 52, 'password': ""}


# SERVER MAINTENANCE
- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts

  tasks:
  - name: omero | restore data repository
    become: yes
    include: idr-omero-restoredb-repo.yml
    when: omero_datareporeset

  # Upgrade
  - name: omero | upgrade
    become: yes
    become_user: "{{ omero_system_user }}"
    command: >
      {{ omero_omego_path }}
      upgrade
      {{ omero_omego_options }}
      {{ omero_omego_db_options }}
      --upgradedb
    args:
      chdir: "{{ omero_serverdir }}"
    when: omero_upgrade

  vars:
    rsync_host: "rsync://idr-rsync.openmicroscopy.org/"
    rsync_dest_datadir: "/tmp/data_dir"
    omero_dbname: idr
    omero_datareporeset: True
    omero_upgrade: True


# START
- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts

  tasks:
  - name: omero | start omero.server
    become: yes
    systemd:
      name: omero
      state: started
