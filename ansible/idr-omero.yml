# Example playbook for installing OMERO.server into a VM
#
# This is initially aimed at testing a mini-IDR, so some production tuning is
# required (limits.d).
# In addition the samba-client and python-pydata roles are also installed
# as they are required for some IDR related tasks.
# For a standard production server you won't need these.


# Testing vars. Set:
# - `idr_net_iface=iface` if your servers use a network interface other
#   then eth0 for inter-machine networking

- hosts: >
    {{ idr_environment | default('idr') }}-database-hosts
    {{ idr_environment | default('idr') }}-a-database-hosts

  roles:
  - role: openmicroscopy.postgresql


# There are two OMERO and database servers. The next two plays set a
# hostvar so that the OMERO servers connect to the correct database

- hosts: "{{ idr_environment | default('idr') }}-omero-hosts"
  tasks:
  - name: Get database host
    set_fact:
      omero_db_host_ansible: "{{ hostvars[groups[idr_environment | default('idr') + '-database-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"

- hosts: "{{ idr_environment | default('idr') }}-a-omero-hosts"
  tasks:
  - name: Get database host
    set_fact:
      omero_db_host_ansible: "{{ hostvars[groups[idr_environment | default('idr') + '-a-database-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"


- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts
    {{ idr_environment | default('idr') }}-a-omero-hosts

  roles:
  - role: openmicroscopy.basedeps
  - role: openmicroscopy.cli-utils
  - role: openmicroscopy.versioncontrol-utils
  - role: openmicroscopy.omero-server
  - role: openmicroscopy.python-pydata
  - role: openmicroscopy.analysis-tools

  # Vars are in group_vars/omero-hosts.yml


# TODO: Add omeroweb hosts group
- hosts: >
    {{ idr_environment | default('idr') }}-omero-hosts
    {{ idr_environment | default('idr') }}-a-omero-hosts

  roles:
  - role: openmicroscopy.redis
  - role: openmicroscopy.omero-web
  - role: openmicroscopy.omero-web-apps

  # Vars are in group_vars/omero-hosts.yml
