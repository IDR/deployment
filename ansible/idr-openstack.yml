---
# Playbook for preparing IDR openstack nodes

- hosts: idr-openstack

  roles:
  - role: network
  - role: upgrade-distpackages
#  - role: lvm-partition
#    lvm_lvname: var_lib
#    lvm_lvmount: /var/lib
#    lvm_lvsize: 100G

  vars:

  post_tasks:
  - name: Setup RDO repository
    become: yes
    yum:
      pkg: https://www.rdoproject.org/repos/rdo-release.rpm
      state: present
  - name: Install packstack
    become: yes
    yum:
      pkg: openstack-packstack
      state: present
    when: openstack_master_node
  - name: Enable root ssh
    become: yes
    lineinfile:
      backup: yes
      create: no
      dest: /etc/ssh/sshd_config
      line: "PermitRootLogin yes"
      regexp: '[\s#]*PermitRootLogin\s.*'
      state: present
    register: sshd
  - name: Restart ssh
    become: yes
    service:
      name: sshd
      state: restarted
    when: sshd.changed
  - name: Enable sudoers.d
    become: yes
    lineinfile:
      backup: no
      create: no
      dest: /etc/sudoers
      insertafter: EOF
      line: "#includedir /etc/sudoers.d"
      state: present
      validate: "visudo -cf %s"

  - name: Disable Network Manager
    become: yes
    service:
      name: NetworkManager
      enabled: no
      state: stopped

# Possible bug: https://bugzilla.redhat.com/show_bug.cgi?id=1272572
#openstack-config --set /etc/cinder/cinder.conf keystone_authtoken auth_uri http://localhost:5000/
#systemctl restart openstack-cinder-api

# https://www.rdoproject.org/networking/neutron-with-existing-external-network/

#openstack-config --set /etc/neutron/plugins/ml2/openvswitch_agent.ini ovs bridge_mappings extnet:br-ex
#openstack-config --set /etc/neutron/plugin.ini ml2 type_drivers vxlan,flat,vlan
#for s in network neutron-openvswitch-agent neutron-server ; do systemctl restart $s; done

#. keystonerc_admin
#neutron net-create external_network --provider:network_type flat --provider:physical_network extnet  --router:external --shared

#neutron subnet-create --name public_subnet --enable_dhcp=False --allocation-pool=start=10.0.0.64,end=10.0.0.127 --gateway=10.0.0.254 external_network 10.0.0.0/24
#neutron router-create router1
#neutron router-gateway-set router1 external_network

#neutron net-create private_network
#neutron subnet-create --name private_subnet private_network 192.168.100.0/24

#neutron router-interface-add router1 private_subnet

#curl http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img | glance image-create --name='cirros image' --visibility public --container-format=bare --disk-format=qcow2

#keystone tenant-create --name internal --description "internal tenant" --enabled true
#keystone user-create --name internal --tenant internal --pass "ome" --email test@example.org --enabled true

#curl http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1601.qcow2 | glance image-create --name='CentOS 7 x86_64 1601' --visibility public --container-format=bare --disk-format=qcow2
# Note for GPFS use raw images so COW works

#
