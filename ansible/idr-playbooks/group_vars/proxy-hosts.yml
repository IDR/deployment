# Parameters for the front-end IDR web proxy
# This includes OMERO.web and Jupyter


######################################################################
# SSL
#nginx_proxy_ssl_certificate_source_path: ~/ansible-files/idr-fullchain.pem
#nginx_proxy_ssl_certificate_key_source_path: ~/ansible-files/idr-privkey.pem


######################################################################
# OMERO.web proxy and caching

# The config generated by omero web wsgi contains X-Forwarded-Proto
# Override it in the front-end proxy by setting a different header
nginx_proxy_forward_scheme_header: X-Forwarded-Proto-Omero-Web
nginx_proxy_cachebuster_port: 9000

# Cache the request path but not the host so that cache can be copied to
# other servers
nginx_proxy_cache_key: "$request_uri"

nginx_proxy_cache_ignore_headers: '"Set-Cookie" "Vary" "Expires"'
nginx_proxy_cache_hide_headers:
- Set-Cookie

nginx_proxy_cache_match_uri:
#- '"~webclient/api/paths_to_object*"'
- '"~web(client|gateway)/(metadata|render)_*"'
- '"~webclient/api/*"'
- '"~static/*"'
- '"~mapr/*"'

#nginx_proxy_cache_match_arg:
#- '"~show=*"'

# Order is important, the first match will be used
nginx_proxy_caches:
- name: omero
  keysize: 10m
  inactive: 30d
  match:
  - default
- name: omerostatic
  keysize: 10m
  inactive: 30d
  match:
  - '"~static/*"'
- name: omerothumbnail
  keysize: 200m
  inactive: 30d
  match:
  - '"~web(client|gateway)/render_thumbnail/*"'
- name: omerorender
  keysize: 4000m
  inactive: 30d
  match:
  - '"~web(client|gateway)/render_*/*"'
- name: omerometadata
  keysize: 300m
  inactive: 30d
  match:
  - '"~webclient/metadata_*"'
#- name: omeroshow
#  keysize: 600m
#  inactive: 30d
#  match:
#  - '"~webclient/.*/?show=*"'
#  - '"~webclient/api/paths_to_object/*"'
- name: omeroapi
  keysize: 10m
  inactive: 30d
  match:
  - '"~webclient/api/*"'
- name: omeromapr
  keysize: 10m
  inactive: 30d
  match:
  - '"~mapr/*"'


######################################################################
# OMERO.web proxy redirects

# Order is important
nginx_proxy_redirect_map:
- match: default
  dest: /

- match: /mito/webclient/?show=screen-1
  dest: /webclient/?show=screen-1101
- match: /mito/webclient/?show=screen-701
  dest: /webclient/?show=screen-1302
- match: /mito/webclient/?show=well-324
  dest: /webclient/?show=well-771034

- match: /tara/webclient/?show=screen-151
  dest: /webclient/?show=screen-1201
- match: /tara/webclient/?show=plate-362
  dest: /webclient/?show=plate-4751

- match: /pgpc/webclient/?show=screen-101
  dest: /webclient/?show=screen-1151
- match: /pgpc/webclient/?show=run-2
  dest: /webclient/?show=plate-4101

- match: ~/mito
  dest: /webclient/?show=screen-1101
- match: ~/tara
  dest: /webclient/?show=screen-1201
- match: ~/pgpc
  dest: /webclient/?show=screen-1151

nginx_proxy_redirect_map_locations:
# TODO: change to 301 when we're happy
- location: "~ ^/(mito|tara|pgpc)($|/)"
  code: 302

# "= /" has higher priority than "/" in the proxy config
nginx_proxy_direct_locations:
# TODO: change to 301 when we're happy
- location: "= /webclient"
  redirect302: /webclient/userdata/?experimenter=-1
- location: "= /"
  redirect302: /about
- location: "^~ /about"
  index: idr.html
  alias: /srv/www/html


######################################################################
# Other

#nginx_proxy_block_locations:
#- "^~ /login"

#nginx_proxy_set_header_host: 'idr-demo.openmicroscopy.org'
