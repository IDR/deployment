# Parameters for the front-end IDR web proxy
# This includes OMERO.web and Jupyter


######################################################################
# nginx and SSL

# We need config options from 1.11
nginx_stable_repo: False

nginx_proxy_worker_processes: 4
nginx_proxy_buffers: 32 16k

nginx_proxy_ssl: True
nginx_proxy_ssl_certificate: /etc/nginx/ssl/idr-fullchain.pem
nginx_proxy_ssl_certificate_key: /etc/nginx/ssl/idr-privkey.pem
nginx_proxy_http2: True


######################################################################
# OMERO.web proxy

nginx_proxy_websockets_enable: True

# The regex is getting complicated, so unroll it into a list and join
_nginx_proxy_omero_locations:
- /webclient/metadata_*
- /webclient/render_*
- /webgateway/metadata_*
- /webgateway/render_*
- /webclient/api/*
- /webclient/search/*
- /mapr/*

_nginx_proxy_backends_omero:
- name: omerocached
  location: ~ {{ _nginx_proxy_omero_locations | join('|') }}
  server: "http://{{ omero_omero_host_ansible }}"
  cache_validity: 30d
- name: omerostatic
  location: ~ /static/*
  server: "http://{{ omero_omero_host_ansible }}"
  cache_validity: 30d
- name: omero
  location: /
  server: "http://{{ omero_omero_host_ansible }}"

# omero_jupyter_host_ansible may be empty
_nginx_proxy_backends_jupyter:
- name: jupyter
  location: "^~ /jupyter"
  server: "http://{{ omero_jupyter_host_ansible | default(None) }}"
  websockets: True
  read_timeout: 86400
  # `proxy_set_header Host $host` is already set in the parent `server` scope,
  # but there seems to be a issue which means it also needs to be set at the
  # `location` scope when websockets are used
  host_header: "$host"

nginx_proxy_backends: >
  {{ _nginx_proxy_backends_omero +
     ((omero_jupyter_host_ansible is defined) |
       ternary(_nginx_proxy_backends_jupyter, [])
     ) }}


# The config generated by omero web wsgi contains X-Forwarded-Proto
# Override it in the front-end proxy by setting a different header
nginx_proxy_forward_scheme_header: X-Forwarded-Proto-Omero-Web


######################################################################
# OMERO.web proxy and caching

nginx_proxy_cachebuster_port: 9000

# Cache the request path but not the host so that cache can be copied to
# other servers
# Ignore the `_=\d+` query parameter
nginx_proxy_cache_key: "$request_uri"
nginx_proxy_cache_key_map:
- match: "~^(.+[\\?\\&])_=\\d+(.*)$"
  key: "$1$2"
# Non-matches default to the unchanged nginx_proxy_cache_key

nginx_proxy_cache_ignore_headers: '"Set-Cookie" "Vary" "Expires"'
nginx_proxy_cache_hide_headers:
- Set-Cookie

nginx_proxy_cache_match_uri:
#- '"~webclient/api/paths_to_object*"'
- '"~web(client|gateway)/(metadata|render)_*"'
- '"~webclient/api/*"'
- '"~static/*"'
- '"~mapr/*"'

#nginx_proxy_cache_match_arg:

# Order is important, the first match will be used
nginx_proxy_caches:
- name: omero
  maxsize: 1g
  keysize: 1m
  inactive: 30d
  match:
  - default
- name: omerostatic
  maxsize: 200m
  keysize: 1m
  inactive: 30d
  match:
  - '"~static/*"'
- name: omerothumbnail
  maxsize: 10g
  keysize: 300m
  inactive: 30d
  match:
  - '"~web(client|gateway)/render_thumbnail/*"'
- name: omerorender
  maxsize: 40g
  keysize: 35m
  inactive: 30d
  match:
  - '"~web(client|gateway)/render_*/*"'
- name: omerometadata
  maxsize: 25g
  keysize: 65m
  inactive: 30d
  match:
  - '"~webclient/metadata_*"'
- name: omeroapi
  maxsize: 10g
  keysize: 320m
  inactive: 30d
  match:
  - '"~webclient/api/*"'
- name: omeromapr
  maxsize: 5g
  keysize: 100m
  inactive: 30d
  match:
  - '"~mapr/*"'


######################################################################
# OMERO.web proxy redirects

# Order is important
nginx_proxy_redirect_map:
- match: default
  dest: /

- match: /mito/webclient/?show=screen-1
  dest: /webclient/?show=screen-1101
- match: /mito/webclient/?show=screen-701
  dest: /webclient/?show=screen-1302
- match: /mito/webclient/?show=well-324
  dest: /webclient/?show=well-771034

- match: /tara/webclient/?show=screen-151
  dest: /webclient/?show=screen-1201
- match: /tara/webclient/?show=plate-362
  dest: /webclient/?show=plate-4751

- match: /pgpc/webclient/?show=screen-101
  dest: /webclient/?show=screen-1151
- match: /pgpc/webclient/?show=run-2
  dest: /webclient/?show=plate-4101

- match: ~/mito
  dest: /webclient/?show=screen-1101
- match: ~/tara
  dest: /webclient/?show=screen-1201
- match: ~/pgpc
  dest: /webclient/?show=screen-1151

nginx_proxy_redirect_map_locations:
# TODO: change to 301 when we're happy
- location: "~ ^/(mito|tara|pgpc)($|/)"
  code: 302

# "= /" has higher priority than "/" in the proxy config
nginx_proxy_direct_locations:
# TODO: change to 301 when we're happy
- location: "= /webclient"
  redirect302: /webclient/userdata/?experimenter=-1
- location: "= /"
  redirect302: /about
- location: "^~ /about"
  alias: /srv/www/html


######################################################################
# Other

#nginx_proxy_block_locations:
#- "^~ /login"

#nginx_proxy_set_header_host: 'idr-demo.openmicroscopy.org'


######################################################################
# Static webpages (/about) on proxy

jekyll_build_sourcedir: /home/omero/about
jekyll_build_root: /srv/www/html
jekyll_build_git_repo: https://github.com/IDR/idr-demo.openmicroscopy.org.git
jekyll_build_force_git: True
jekyll_build_baseurl: /about
