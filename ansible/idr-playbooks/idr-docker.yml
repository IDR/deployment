# Setup IDR Docker nodes
# Inspired by https://thisendout.com/2016/09/13/deploying-docker-swarm-with-ansible/

- hosts: "{{ idr_environment | default('idr') }}-dockermanager-hosts,{{ idr_environment | default('idr') }}-dockerworker-hosts"

#  roles:
#  - role: docker
#    docker_use_ipv4_nic_mtu: True


- hosts: "{{ idr_environment | default('idr') }}-dockermanager-hosts"

  tasks:

  - set_fact:
      docker_swarm_manager_ip: "{{ hostvars[groups[idr_environment | default('idr') + '-dockermanager-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"

  - block:

    - name: docker swarm | get worker token
      become: yes
      command: docker swarm join-token worker -q
      register: docker_swarm_worker_token_out

    rescue:

    - name: docker swarm | initialise
      become: yes
      command: docker swarm init --advertise-addr {{ docker_swarm_manager_ip }}

    - name: docker swarm | get worker token
      become: yes
      command: docker swarm join-token worker -q
      register: docker_swarm_worker_token_out

  - set_fact:
      docker_swarm_worker_token: "{{ docker_swarm_worker_token_out.stdout }}"


- hosts: "{{ idr_environment | default('idr') }}-dockerworker-hosts"

  tasks:

  - name: docker swarm | join worker
    become: yes
    command: docker swarm join --token {{ token }} {{ manager_ip }}

  vars:
    token: "{{ hostvars[groups[idr_environment | default('idr') + '-dockermanager-hosts'][0]]['docker_swarm_worker_token'] }}"
    manager_ip: "{{ hostvars[groups[idr_environment | default('idr') + '-dockermanager-hosts'][0]]['docker_swarm_manager_ip'] }}"
