# Deployment management servers

# This must be run using the private openstack dynamic inventory since it
# requires the internal network IPs of each host

#- hosts: database-hosts,omero-hosts,proxy-hosts,bastion-hosts,dockermanager-hosts,dockerworker-hosts,management-hosts
  # Load all host vars

- hosts: management-hosts

  roles:
  - role: basedeps  # munin requires EPEL
  - role: munin
    munin_slack_token: "{{ idr_secret_management_slack_token | default(None) }}"
    munin_slack_channel: "#trash"
    munin_slack_username: "Test Munin Notifications"
    munin_slack_emoji: ":pony:"
    munin_slack_url: http://{{ ansible_host }}/munin/problems.html
    # List of hosts to be monitored
    munin_hosts:
    - name: localhost
      address: 127.0.0.1
      extra: ["use_node_name yes"]
    munin_openstack_groups:
    - database-hosts
    - omero-hosts
    - proxy-hosts
    - bastion-hosts
    - dockermanager-hosts
    - dockerworker-hosts
    - management-hosts

  post_tasks:
    - name: Install httpd
      become: yes
      yum:
        name: httpd
        state: present

    # TODO: Restart if /etc/httpd/conf.d/munin.conf changed
    - name: Start httpd
      become: yes
      service:
        enabled: yes
        name: httpd
        state: started
        #state: restarted

- hosts: database-hosts,omero-hosts,proxy-hosts,bastion-hosts,dockermanager-hosts,dockerworker-hosts,management-hosts
  roles:
  - role: basedeps  # munin-node requires EPEL
  - role: munin-node
    munin_node_allowed_ips:
    - '^192\.168\.\d+\.\d+$'
