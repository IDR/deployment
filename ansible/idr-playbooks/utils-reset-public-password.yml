# Example playbook for resetting the public user password on the IDR
# This is useful for giving people API access to a clone of the IDR
# without revealing the production public password

- hosts: "{{ idr_environment | default('idr') }}-database-hosts"

  name: Get facts from database hosts (need IP)
  tasks: []

- hosts: "{{ idr_environment | default('idr') }}-omero-hosts"

  pre_tasks:
  - set_fact:
      omero_db_host_ansible: "{{ hostvars[groups[idr_environment | default('idr') + '-database-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"

  tasks:
  - name: Reset omero password
    command: >
      psql -h {{ omero_db_host_ansible }} -U {{ omero_dbuser }}
      -d {{ omero_dbname }} -w -c
      "UPDATE password SET hash = '{{ omero_public_hash }}'
        WHERE experimenter_id = {{ omero_public_userid }};"
    environment:
      PGPASSWORD: "{{ omero_dbpassword }}"
