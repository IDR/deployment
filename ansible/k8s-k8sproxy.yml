# Setup the K8s shared web proxy

# Load hostvars
- hosts: >
    {{ idr_environment | default('k8s') }}-vae-hosts
    {{ idr_environment | default('k8s') }}-train-hosts


- hosts: "{{ idr_environment | default('idr') }}-k8sproxy-hosts"

  pre_tasks:

  - name: Get IPs
    set_fact:
      k8s_vae_nodes: >-
        {{
          (groups[idr_environment | default('k8s') + '-vae-node-hosts']) |
          default([]) |
          map('extract', hostvars,
            ['ansible_' + (idr_net_iface | default('eth0')), 'ipv4', 'address']) |
          sort
        }}
      k8s_vae_masters: >-
        {{
          (groups[idr_environment | default('k8s') + '-vae-master-hosts']) |
          default([]) |
          map('extract', hostvars,
            ['ansible_' + (idr_net_iface | default('eth0')), 'ipv4', 'address']) |
          sort
        }}
      k8s_train_nodes: >-
        {{
          groups[idr_environment | default('k8s') + '-train-node-hosts'] |
          default([]) |
          map('extract', hostvars,
            ['ansible_' + (idr_net_iface | default('eth0')), 'ipv4', 'address']) |
          sort
        }}
      k8s_train_masters: >-
        {{
          groups[idr_environment | default('k8s') + '-train-master-hosts'] |
          default([]) |
          map('extract', hostvars,
            ['ansible_' + (idr_net_iface | default('eth0')), 'ipv4', 'address']) |
          sort
        }}

  roles:

  - role: openmicroscopy.selinux-utils

  # Default to a self-signed certificate, to use production certificates set:
  # ssl_certificate_content: "{{ secret_certificate_content }}"
  # ssl_certificate_key_content: "{{ secret_certificate_key_content }}"
  # ssl_certificate_selfsigned_create: False
  - role: openmicroscopy.ssl-certificate
    ssl_certificate_path: /etc/ssl/idr-fullchain.pem
    ssl_certificate_key_path: /etc/ssl/idr-privkey.pem
    ssl_certificate_combined_path: /etc/ssl/idr-combined.pem

  # TODO: Restart haproxy when certificate changes
  - role: openmicroscopy.haproxy
    haproxy_cfg_template: "{{ playbook_dir }}/templates/k8sproxy-haproxy.cfg.j2"
    # haproxy needs some special setup to log to a file
    haproxy_syslog_configure_udp: True
    haproxy_syslog_enable: True
