# Kubespray includes a playbook with it's own set of groups.
# We can either copy and modify the playbook to match our group name,
# or dynamically add hosts to the required kubespray groups.
# This does the latter.
#
# Requires Ansible 2.4.
#
# We don't need kubespray's bastion handling because our custo openstack
# dynamic inventory will automatically setup the SSH ProxyCommand
#
# WARNING: Since we have two separate clusters we must clear the
# dynamically created groups before running kubespray on other clusters


- hosts: localhost
  tasks:
  - meta: refresh_inventory


- hosts: "{{ idr_environment | default('idr') }}-vae-master-hosts"
  tasks:
  - name: Create kubespray kube-master group
    add_host:
      name: "{{ item }}"
      groups:
      - k8s-cluster
      - kube-master
      - etcd
    with_items: "{{ play_hosts }}"


- hosts: "{{ idr_environment | default('idr') }}-vae-node-hosts"
  tasks:
  - name: Create kubespray kube-node group
    add_host:
      name: "{{ item }}"
      groups:
      - k8s-cluster
      - kube-node
    with_items: "{{ play_hosts }}"


- hosts: "{{ idr_environment | default('idr') }}-vae-storage-hosts"
  tasks:
  - name: Create kubespray network-storage group
    add_host:
      name: "{{ item }}"
      groups:
      - gfs-cluster
      - network-storage
    with_items: "{{ play_hosts }}"


- hosts: localhost
  tasks:
  - debug:
      msg: "{{ item }}: {{ groups[item] }}"
    with_items:
    - kube-master
    - kube-node
    - etcd
    - k8s-cluster


- hosts: localhost
  tasks:
  - debug:
      msg: "{{ item }}: {{ groups[item] }}"
    with_items:
    - gfs-cluster
    - network-storage
    when: '((idr_environment_idr | default("idr")) + "-vae-storage-hosts") in groups'


- include: ../../kubespray/cluster.yml

- include: ../../kubespray/contrib/network-storage/glusterfs/glusterfs.yml


- hosts: "{{ idr_environment | default('idr') }}-vae-master-hosts"
  run_once: true

  tasks:

  - name: Load Kubernetes admin.conf file
    become: yes
    slurp:
      src: /etc/kubernetes/admin.conf
    register: _idr_kubernetes_admin_conf

  - name: Update server and save kubeconfig locally
    copy:
      content: >-
        {{ _idr_kubernetes_admin_conf.content | b64decode |
           regex_replace(
             'server: https://.+:6443',
             'server: https://test-k8s-vae.openmicroscopy.org:6450')
        }}
      dest: "{{ playbook_dir }}/{{ idr_environment | default('idr') }}-vae.kubeconfig"
    delegate_to: localhost


- hosts: localhost
  tasks:
  - meta: refresh_inventory
