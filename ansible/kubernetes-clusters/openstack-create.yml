---
- hosts: localhost
  connection: local

  # These variables can be defined in a variables file and included
  # on the ansible command line as -e @path/to/secret.yml
  vars:
    # Do not change these unless you are running multiple deployments
    - idr_deployment_cloud: k8s
    - idr_environment_idr: k8s
    # REQUIRED: List of public SSH keys
    - idr_keypair_keys:
    # Change these to match the image and flavours in your OpenStack cloud
    #- vm_image: CentOS 7
    - vm_image: CentOS-7-1708
    #- vm_flavour: m1.large
    - vm_flavour: m1.medium
    #- vm_flavour_large: m1.xlarge
    - vm_flavour_large: m1.medium
    #- vm_flavour_medium: m1.medium
    #- vm_flavour_medium: m1.medium

    - idr_environment_idr_subnet: 172.16.0.0/16


  roles:

    ############################################################
    # Keypairs

    - role: IDR.openstack-idr-keypairs
      idr_keypair_name: k8s-deployment-key


    ############################################################
    # Security groups

    - role: IDR.openstack-idr-security-groups


    ############################################################
    # Networks

    - role: IDR.openstack-idr-network
      idr_network_name: "{{ idr_environment_idr }}"
      idr_network_subnet: "{{ idr_environment_idr_subnet }}"


    ############################################################
    # VAE Instances

    - role: IDR.openstack-idr-instance
      idr_environment: "{{ idr_environment_idr }}-vae"
      idr_vm_name: "{{ idr_environment_idr }}-vae-master"
      idr_vm_image: "{{ vm_image }}"
      idr_vm_flavour: "{{ vm_flavour }}"
      idr_vm_extra_groups:
      - "{{ idr_environment_idr }}-vae-master-hosts"
      - "{{ idr_environment_idr }}-vae-hosts"
      idr_vm_networks:
      - net-name: "{{ idr_environment_idr }}"
      idr_vm_count: 1

    - role: IDR.openstack-idr-instance
      idr_environment: "{{ idr_environment_idr }}-vae"
      idr_vm_name: "{{ idr_environment_idr }}-vae-node"
      idr_vm_image: "{{ vm_image }}"
      idr_vm_flavour: "{{ vm_flavour_large }}"
      idr_vm_extra_groups:
      - "{{ idr_environment_idr }}-vae-node-hosts"
      - "{{ idr_environment_idr }}-vae-hosts"
      idr_vm_networks:
      - net-name: "{{ idr_environment_idr }}"
      idr_vm_count: 1


    ############################################################
    # Training Instances

    - role: IDR.openstack-idr-instance
      idr_environment: "{{ idr_environment_idr }}-train"
      idr_vm_name: "{{ idr_environment_idr }}-train-master"
      idr_vm_image: "{{ vm_image }}"
      idr_vm_flavour: "{{ vm_flavour }}"
      idr_vm_extra_groups:
      - "{{ idr_environment_idr }}-train-master-hosts"
      - "{{ idr_environment_idr }}-train-hosts"
      idr_vm_networks:
      - net-name: "{{ idr_environment_idr }}"
      idr_vm_count: 1

    - role: IDR.openstack-idr-instance
      idr_environment: "{{ idr_environment_idr }}-train"
      idr_vm_name: "{{ idr_environment_idr }}-train-node"
      idr_vm_image: "{{ vm_image }}"
      idr_vm_flavour: "{{ vm_flavour_large }}"
      idr_vm_extra_groups:
      - "{{ idr_environment_idr }}-train-node-hosts"
      - "{{ idr_environment_idr }}-train-hosts"
      idr_vm_networks:
      - net-name: "{{ idr_environment_idr }}"
      idr_vm_count: 1


    ############################################################
    # Gateway/proxy/bastion

    - role: IDR.openstack-idr-instance
      idr_environment: "{{ idr_environment_idr }}"
      idr_vm_name: "{{ idr_environment_idr }}-proxy"
      idr_vm_image: "{{ vm_image }}"
      idr_vm_flavour: "{{ vm_flavour }}"
      idr_vm_proxy: True
      idr_vm_bastion: True
      idr_vm_assign_floating_ip: True
      idr_vm_extra_groups:
      - "{{ idr_environment_idr }}-proxy"
      idr_vm_networks:
      - net-name: "{{ idr_environment_idr }}"
      idr_vm_security_groups:
      - default
      - idr-bastion-external
      - idr-web-external
