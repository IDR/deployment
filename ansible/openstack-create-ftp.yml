---
- hosts: localhost
  connection: local

  # These variables can be defined in a variables file and included
  # on the ansible command line as -e @path/to/secret.yml
  vars:
    # Do not change these unless you are running multiple deployments
    - idr_deployment_cloud: ebi
    - idr_environment_idr: idrftp
    # REQUIRED: List of public SSH keys
    - idr_keypair_keys:
    # Change these to match the image and flavours in your OpenStack cloud
    - vm_image: CentOS 7
    - vm_flavour: m1.medium
    - idr_environment_idr_subnet: 192.168.131.0/24


  pre_tasks:

  ############################################################
  # Security groups

  - name: IDR FTP external access security group
    os_security_group:
      description: External access to IDR FTP (managed by Ansible)
      name: idr-ftp-external
      state: present

  - name: IDR FTP external access security group rules
    os_security_group_rule:
      direction: ingress
      port_range_min: "{{ item.min }}"
      port_range_max: "{{ item.max }}"
      protocol: tcp
      remote_ip_prefix: 0.0.0.0/0
      security_group: idr-ftp-external
      state: present
    with_items:
    - min: 22
      max: 22
    - min: 32021
      max: 32031


  roles:

  ############################################################
  # Keypairs

  - role: IDR.openstack-idr-keypairs


  ############################################################
  # Networks

  - role: IDR.openstack-idr-network
    idr_network_name: "{{ idr_environment_idr }}"
    idr_network_subnet: "{{ idr_environment_idr_subnet }}"


  ############################################################
  # Instances

  - role: IDR.openstack-idr-instance
    idr_environment: "{{ idr_environment_idr }}"
    idr_vm_name: "{{ idr_environment_idr }}-ftp"
    idr_vm_image: "{{ vm_image }}"
    idr_vm_flavour: "{{ vm_flavour }}"
    idr_vm_assign_floating_ip: True
    idr_vm_bastion: True
    idr_vm_extra_groups:
    - idrftp-ftp-hosts
    idr_vm_networks:
    - net-name: "{{ idr_environment_idr }}"
    idr_vm_security_groups:
    - default
    - idr-ftp-external


  ############################################################
  # Volumes

  - role: openmicroscopy.openstack-volume-storage
    openstack_volume_size: 1024
    openstack_volume_vmname: "{{ idr_environment_idr }}-ftp"
    openstack_volume_name: ftpdata
    openstack_volume_device: /dev/vdb
