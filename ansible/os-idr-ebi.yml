---
# Playbook for starting an IDR-like OMERO in the EBI Embassy
# openstack cloud.

- include: os-create.yml
  vars:
    omero_vm_extra_groups: "ebi-nfs,idr-hosts"
    os_cloud_provider: ebi

- include: os-volumes.yml
  vars:
    os_cloud_provider: ebi

- include: os-local-users.yml
# Variables for this section are in a private file

- hosts: database-hosts
  roles:
  - role: storage-volume-initialise
    storage_volume_initialise_device: /dev/vdb
    storage_volume_initialise_mount: /var/lib/pgsql

# TODO: At present the existing volume has one partition instead of being a
# raw disk image
- hosts: omero-hosts
  roles:
  - role: storage-volume-initialise
    storage_volume_initialise_device: /dev/vdb1
    storage_volume_initialise_mount: /data

- hosts: proxy-hosts
  roles:
  - role: storage-volume-initialise
    storage_volume_initialise_device: /dev/vdb
    storage_volume_initialise_mount: /var/cache/nginx

- include: idr-ebi-nfs.yml

- include: os-omero.yml
# Vars are in os-omero.yml so that the playbook can be run independently

- include: idr-user-utils.yml
