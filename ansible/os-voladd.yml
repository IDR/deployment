---
# Playbook for attaching an extra volume to
# an openstack instance.

- hosts: localhost
  connection: local
  gather_facts: false

  vars:

    os_vol_name: var
    os_vol_size: 100 # GB
    os_vol_dev:  /dev/vdb

  tasks:

  - fail: msg="os_voladd_vm_name is required"
    when: os_voladd_vm_name is undefined

  - name: create volume
    os_volume:
      state: present
      size: "{{ os_vol_size }}"
      display_name: "{{ os_voladd_vm_name }}-{{ os_vol_name }}"
    register: osvolume

  - name: attach volume to host
    os_server_volume:
      state: present
      server: "{{ os_voladd_vm_name }}"
      volume: "{{ os_voladd_vm_name }}-{{ os_vol_name }}"
      device: "{{ os_vol_dev }}"
    register: osattachment

  - debug:
      msg: "Device: {{ osvolume.volume }}"
