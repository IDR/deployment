---
# Install GPFS packages extracted and compiled by the gpfs-build tasks

- name: gpfs | current kernel version
  fail:
    msg: "Current kernel {{ ansible_kernel }} must match specified GPFS kernel {{ gpfs_kernel_version }}"
  when: (gpfs_install_check_kernel_version == True) and (ansible_kernel != gpfs_kernel_version)

- name: gpfs | download directory
  become: yes
  file:
    path: /opt/gpfs-installer
    state: directory

# Note this is a relative user directory to avoid problems with running rsync as root
- name: gpfs | copy rpms
  synchronize:
    dest: gpfs-rpms/
    src: "{{ gpfs_local_rpm_dir }}/"

- name: gpfs | remove packages
  become: yes
  yum:
    name: "{{ gpfs_remove_rpms }}"
    state: absent

- name: gpfs | install installer packages
  become: yes
  yum:
    name: gpfs-rpms/1/{{ item }}
    state: present
  with_items: "{{ gpfs_installer_rpms }}"

- name: gpfs | install patch packages
  become: yes
  yum:
    name: gpfs-rpms/2/{{ item }}
    state: present
  with_items: "{{ gpfs_patch_rpms }}"

- name: gpfs | install kernel module
  become: yes
  yum:
    name: gpfs-rpms/3/{{ gpfs_kernel_rpm_name }}
    state: present

- name: gpfs | nsd access
  become: yes
  authorized_key:
    key: "{{ item }}"
    manage_dir: yes
    state: present
    user: root
  with_items: "{{ gpfs_public_keys | default([]) }}"

# This regexp checks for the absence of gpfs_binaries_path in PATH
# It won't work if there are multiple PATH statements in .bash_profile
# https://coderwall.com/p/ynvi0q/updating-path-with-ansible-system-wide
- name: gpfs | root path
  become: yes
  lineinfile:
    backrefs: yes
    backup: yes
    create: no
    dest: /root/.bash_profile
    line: 'PATH=\1\2:{{ gpfs_binaries_path }}\3'
    regexp: 'PATH=(["]*)((?!.*?{{ gpfs_binaries_path }}).*?)(["]*)$'
    state: present
