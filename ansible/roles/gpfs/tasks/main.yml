---
# tasks file for roles/gpfs

- name: gpfs | current kernel version
  set_fact:
    kernel_version: "{{ ansible_kernel }}"

- name: gpfs | kernel module prebuilt
  set_fact:
    build_module: gpfs_kernel_rpm_prebuilt is not defined or not gpfs_kernel_rpm_prebuilt

- name: gpfs | install system requirements
  become: yes
  yum:
    name: "{{ item }}"
    state: present
  with_items:
  - kernel-devel
  - kernel-headers
  - kernel-tools
  - kernel-tools-libs
  - rpm-build
  - gcc-c++
  when: build_module

- name: gpfs | download directory
  become: yes
  file:
    path: /opt/gpfs-installer
    state: directory

- name: gpfs | Get GPFS package (url)
  become: yes
  get_url:
    checksum: sha1:{{ gpfs_package_sha1 }}
    dest: /opt/gpfs-installer/{{ gpfs_package_filename }}
    mode: 0755
    url: "{{ gpfs_package_source }}"
    url_password: "{{ gpfs_download_password | default(None) }}"
    url_username: "{{ gpfs_download_username | default(None) }}"
  when: gpfs_package_source | search("\w+://\w+")

- name: gpfs | Get GPFS package (copy)
  become: yes
  copy:
    dest: /opt/gpfs-installer/{{ gpfs_package_filename }}
    force: no
    mode: 0755
    src: "{{ gpfs_package_source }}"
    validate: sh -c '[ "$(cat %s | sha1sum)" = "{{ gpfs_package_sha1 }}  -" ]'
  when: not (gpfs_package_source | search("\w+://\w+"))

- name: gpfs | Extract packages
  become: yes
  command: /opt/gpfs-installer/{{ gpfs_package_filename }} --silent
  args:
    creates: "{{ gpfs_package_test_unpacked }}"

- name: gpfs | Install packages
  become: yes
  yum:
    name: /usr/lpp/mmfs/4.1.1/gpfs_rpms/{{ item }}
    state: present
  with_items:
  - gpfs.base-{{ gpfs_rpm_version }}.x86_64.rpm
  - gpfs.docs-{{ gpfs_rpm_version }}.noarch.rpm
  - gpfs.ext-{{ gpfs_rpm_version }}.x86_64.rpm
  - gpfs.gpl-{{ gpfs_rpm_version }}.noarch.rpm
  - gpfs.gskit-{{ gpfs_gskit_version }}.x86_64.rpm
  - gpfs.hadoop-2-connector-{{ gpfs_rpm_version }}.x86_64.rpm
  - gpfs.msg.en_US-{{ gpfs_rpm_version }}.noarch.rpm

- name: gpfs | nsd access
  become: yes
  authorized_key:
    key: "{{ item }}"
    manage_dir: yes
    state: present
    user: root
  with_items: "{{ gpfs_public_keys | default([]) }}"

# Somewhere between kernel 3.10.0-229.14.1.el7.x86_64 and 3.10.0-327.4.5.el7.x86_64
# the definition of generic_setlease was changed:
# https://github.com/torvalds/linux/commit/e6f5c78930e409f3a6b37f5484313a416359ac7f
# This is an attempt to patch the GPFS module
- name: gpfs | patch kernel module
  become: yes
  patch:
    dest: /usr/lpp/mmfs/src/gpl-linux/verdep.h
    src: mmfs-src-gpl-linux-verdep.h.patch
  when: build_module

- name: gpfs | build kernel module
  become: yes
  command: /usr/lpp/mmfs/bin/mmbuildgpl --buildrpm
  args:
    creates: /root/rpmbuild/RPMS/x86_64/{{ gpfs_kernel_rpm_name }}
  environment:
    LINUX_DISTRIBUTION: REDHAT_AS_LINUX
  register: kernelbuild
  when: build_module

- name: gpfs | install kernel module (locally built)
  become: yes
  yum:
    name: /root/rpmbuild/RPMS/x86_64/{{ gpfs_kernel_rpm_name }}
    state: present
  when: build_module

- name: gpfs | install kernel module (prebuilt)
  become: yes
  yum:
    name: "{{ gpfs_kernel_rpm_prebuilt }}"
    state: present
  when: not build_module

# TODO
# name: gpfs | fetch kernel module
