---
# tasks file for roles/gpfs

- name: gpfs | install system requirements
  become: yes
  yum:
    name: "{{ item }}"
    state: present
  with_items:
  - kernel-devel
  - kernel-headers
  - kernel-tools
  - kernel-tools-libs
  - rpm-build
  - gcc-c++

- name: gpfs | download directory
  become: yes
  file:
    path: /opt/gpfs-installer
    state: directory

- name: gpfs | Get GPFS package (url)
  become: yes
  get_url:
    checksum: sha1:{{ gpfs_package_sha1 }}
    dest: /opt/gpfs-installer/{{ gpfs_package_filename }}
    mode: 0755
    url: "{{ gpfs_package_source }}"
    url_password: "{{ gpfs_download_password | default(None) }}"
    url_username: "{{ gpfs_download_username | default(None) }}"
  when: gpfs_package_source | search("\w+://\w+")

- name: gpfs | Get GPFS package (copy)
  become: yes
  copy:
    dest: /opt/gpfs-installer/{{ gpfs_package_filename }}
    force: no
    mode: 0755
    src: "{{ gpfs_package_source }}"
    validate: sh -c '[ "$(cat %s | sha1sum)" = "{{ gpfs_package_sha1 }}  -" ]'
  when: not (gpfs_package_source | search("\w+://\w+"))

- name: gpfs | Extract packages
  become: yes
  command: /opt/gpfs-installer/{{ gpfs_package_filename }} --silent
  args:
    creates: "{{ gpfs_package_test_unpacked }}"

- name: gpfs | Install packages
  become: yes
  yum:
    name: /usr/lpp/mmfs/4.1.1/gpfs_rpms/{{ item }}
    state: present
  with_items:
  - gpfs.base-4.1.1-0.x86_64.rpm
  - gpfs.docs-4.1.1-0.noarch.rpm
  - gpfs.ext-4.1.1-0.x86_64.rpm
  - gpfs.gpl-4.1.1-0.noarch.rpm
  - gpfs.gskit-8.0.50-40.x86_64.rpm
  - gpfs.hadoop-2-connector-4.1.1-0.x86_64.rpm
  - gpfs.msg.en_US-4.1.1-0.noarch.rpm

- name: gpfs | nsd access
  become: yes
  authorized_key:
    key: "{{ item }}"
    manage_dir: yes
    state: present
    user: root
  with_items: "{{ gpfs_public_keys }}"

- name: gpfs | build kernel module
  become: yes
  command: /usr/lpp/mmfs/bin/mmbuildgpl --buildrpm
  args:
#    creates:
  environment:
    LINUX_DISTRIBUTION: REDHAT_AS_LINUX
  register: kernelbuild




    
#
