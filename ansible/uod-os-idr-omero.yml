---
# Playbook for starting an IDR-like OMERO in the UoD
# openstack cloud.

- include: os-create.yml
  vars:
    omero_vm_extra_groups: "uod-nfs,idr-hosts"

- include: os-voladd.yml
  vars:
    os_vol_name: "db"
    os_vol_dev:  /dev/vdb
    os_voladd_vm_name: "{{ database_vm_name }}"

- include: os-voladd.yml
  vars:
    os_vol_name: "data"
    os_vol_dev:  /dev/vdb
    os_voladd_vm_name: "{{ omero_vm_name }}"

- include: os-voladd.yml
  vars:
    os_vol_name: "nginxcache"
    os_vol_dev:  /dev/vdb
    os_voladd_vm_name: "{{ gateway_vm_name }}"
    os_vol_size: 20

- hosts: database-hosts, omero-hosts, proxy-hosts
  roles:
  - role: sudoers
#    sudoers_individual_commands:
  - role: local-accounts
#    local_accounts_create:


- hosts: database-hosts
  roles:
  - role: storage-volume-initialise
    storage_volume_initialise_device: /dev/vdb
    storage_volume_initialise_mount: /var/lib/pgsql

- hosts: omero-hosts
  roles:
  - role: storage-volume-initialise
    storage_volume_initialise_device: /dev/vdb
    storage_volume_initialise_mount: /data

- hosts: proxy-hosts
  roles:
  - role: storage-volume-initialise
    storage_volume_initialise_device: /dev/vdb
    storage_volume_initialise_mount: /var/cache/nginx

- include: idr-dundee-nfs.yml

# Provides git and other libraries
- include: os-omero.yml
  vars:
    omero_release: OMERO-build
    omero_omego_additional_args: "--ci 10.0.51.113:58080"
    omero_server_config: {"omero.jvmcfg.heap_size.blitz": "16G"}

- include: idr-metadata.yml
