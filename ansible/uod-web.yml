---
- name: OME Website Setup
  hosts: web-linux # TODO?
  vars:
    ansible_user: centos
    site_owner: centos
    site_group: centos
    dev_website_root: /var/www/www-dev.openmicroscopy.org/html
    dev_site_name: www-dev.openmicroscopy.org
    dev_site_aliases:
      - web-test.openmicroscopy.org
    dev_site_account: lunson
    dev_site_branch: ome-redesign-master
    live_website_root: /var/www/www.openmicroscopy.org/html
    live_site_name: www-live.openmicroscopy.org
    live_site_aliases:
      - openmicroscopy.org
  roles:
    - role: versioncontrol-utils
    - role: nginx
    - role: jenkinsslave

  tasks:

    - name: Install required packages
      become: yes
      yum:
        name: "{{ item }}"
        state: present
      with_items:
       - rubygems
       - ruby-devel
       - make
       - gcc

    - name: Install Bundler
      gem:
        name: bundler
        state: present
        user_install: no
      become: yes

    - name: Install Jekyll
      gem:
        name: jekyll
        state: present
        user_install: no
        include_doc: no
      become: yes

    - name: Create {{ dev_site_name }} root directory
      file:
        state: directory
        dest: "{{ dev_website_root }}"
        owner: "{{ site_owner }}"
        group: "{{ site_group }}"
        mode: 0755
        serole: _default
        setype: _default
        seuser: _default
      become: yes

    - name: Clone {{ dev_site_name }} source code repository
      git:
        repo: https://github.com/{{ dev_site_account }}/www.openmicroscopy.org
        version: "{{ dev_site_branch }}"
        dest: /home/{{ site_owner }}/{{ dev_site_name }}
      tags:
        - quickdeploy

    - name: Build the website using Jekyll
      command: jekyll build chdir=/home/{{ site_owner }}/{{ dev_site_name }} --destination {{ dev_website_root }}
      tags:
        - quickdeploy

    - name: Update Nginx configuration for {{ dev_site_name }}
      template:
        src: templates/www-nginx.j2
        dest: /etc/nginx/conf.d/{{ dev_site_name }}.conf
      become: yes
      notify: restart nginx
      tags:
        - quickdeploy

    # - name: live website deploy directory
    #   file: state=directory dest="{{ live_website_root }}" owner="{{ site_owner }}" group="{{ site_group }}" mode=0755 serole=_default setype=_default seuser=_default
    #   become: yes
    # - name: nginx configuration for {{ live_site_name }}
    #   template: src=templates/{{ live_site_name }}.nginx.conf dest=/etc/nginx/conf.d/01-{{ live_site_name }}.conf
    #   become: yes
    #   notify:
    #     - reload nginx

  post_tasks:
