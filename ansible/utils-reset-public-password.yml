# Example playbook for installing OMERO.server into a VM
#
# This is initially aimed at testing a mini-IDR, so some production tuning is
# required (limits.d).
# In addition the samba-client and python-pydata roles are also installed
# as they are required for some IDR related tasks.
# For a standard production server you won't need these.


# Testing vars. Set:
# - `idr_nginx_ssl_self_signed=True` to generate a self-signed https cert
# - `idr_net_iface=iface` if your servers use a network interface other
#   then eth0 for inter-machine networking

- hosts: "{{ idr_environment | default('idr') }}-database-hosts"

  name: Get facts from database hosts (need IP)
  tasks: []

- hosts: "{{ idr_environment | default('idr') }}-omero-hosts"

  pre_tasks:
  - set_fact:
      omero_db_host_ansible: "{{ hostvars[groups[idr_environment | default('idr') + '-database-hosts'][0]]['ansible_' + (idr_net_iface | default('eth0'))]['ipv4']['address']}}"

  tasks:
  - name: Reset omero password
    command: >
      psql -h {{ omero_db_host_ansible }} -U {{ omero_dbuser }}
      -d {{ omero_dbname }} -w -c
      "UPDATE password SET hash = '{{ omero_public_hash }}'
        WHERE experimenter_id = {{ omero_public_userid }};"
    environment:
      PGPASSWORD: "{{ omero_dbpassword }}"
