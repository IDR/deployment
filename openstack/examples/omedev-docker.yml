# Example playbook for installing upstream Docker into a VM
# You must attach a second volume to your VM 
#
# E.g. To use this on an Openstack CentOS7 cloud instance:
# 1. Create a new CentOS7 cloud instance (size can be quite small)
# 2. Create a new volume for Docker
# 3. Attach this volume to the instance
# 4. Run this playbook, e.g.:
#     export ANSIBLE_ROLES_PATH=infrastructure/ansible/roles
#     ansible-playbook -i openstack.py -l VM-HOSTNAME -vv -u centos \
#         infrastructure/openstack/examples/omedev-docker.yml

# Set hosts to all so this can be run locally, or pushed out to any testing VM.
# If you are going to use this as part of a production playbook you should
# change this to a host-group to avoid accidents.
- hosts: localhost, all

  pre_tasks:

    - name: Install LVM
      become: yes
      yum:
        pkg: lvm2
        state: present

    - name: Create volume group
      become: yes
      lvg:
        pvs: "{{ physical_drive }}"
        state: present
        vg: "{{ docker_vgname }}"

  roles:
  - role: upgrade-distpackages
  - role: docker

  vars:
    physical_drive: /dev/vdb

    docker_use_upstream_repo: True
    docker_use_custom_storage: True
    docker_vgname: VGdocker
    docker_poolsize: 80%VG
    docker_metadatasize: 256M
    docker_volumesize: 19%VG
    docker_groupmembers: ["{{ ansible_user }}"]
